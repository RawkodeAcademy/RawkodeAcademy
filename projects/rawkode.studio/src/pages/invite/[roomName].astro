---
import "@/styles/global.css";
import Starfield from "@/components/effects/Starfield.astro";
import InviteRoomForm from "@/components/livestreams/active/invite-room-form";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { roomClientService } from "@/lib/livekit";
import TravelIndicator from "../../components/effects/TravelIndicator.astro";

// Get the roomName from the URL parameter
const { roomName } = Astro.params;

// Redirect if no room name is provided
if (!roomName) {
	return Astro.redirect("/");
}

// Check if the room actually exists
let roomExists = false;
try {
	const rooms = await roomClientService.listRooms();
	roomExists = rooms.some((room) => room.name === roomName);
} catch (error) {
	console.error("Error checking if room exists:", error);
	// Continue anyway, to show the "room not available" message
}

// Check if user is authenticated
const user = Astro.locals.user;

// Don't auto-redirect directors - let them choose to join
// They may have just left the room intentionally
---

<BaseLayout title={`Join ${roomName} - Live Stream`}>
  <!-- Space background with stars -->
  <Starfield seed={roomName} />

  <!-- Invitation UI Container -->
  <div id="invitation-container" class="relative min-h-screen flex flex-col pointer-events-none">
    <!-- Content -->
    <div class="flex-1 flex items-center justify-center px-4 py-12 z-10">
      <div class="w-full max-w-md backdrop-blur-md rounded-lg p-6 border border-border/50 bg-background/80 shadow-lg pointer-events-auto">
        <!-- Header with room name -->
        <div class="mb-4">
          <h1 class="text-2xl font-bold text-center">{roomName}</h1>
          <p class="mt-2 text-center text-muted-foreground">
            You've been invited to join this live stream
          </p>
        </div>

        <!-- Join form and status -->
        <InviteRoomForm
          roomName={roomName}
          roomExists={roomExists}
          isDirector={!!user}
          directorName={user?.preferred_username || user?.name}
          client:load
        />

        <!-- Footer with additional info -->
        <p class="mt-6 text-center text-xs text-muted-foreground">
          Powered by RawkodeStudio &copy; {new Date().getFullYear()}
        </p>
      </div>
    </div>
  </div>


  <TravelIndicator />
</BaseLayout>
