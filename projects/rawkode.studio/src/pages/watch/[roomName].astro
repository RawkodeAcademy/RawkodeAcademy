---
import "@/styles/global.css";
import { LIVEKIT_URL } from "astro:env/server";
import { RoomWrapper } from "@/components/livestreams/room/RoomWrapper";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { roomClientService } from "@/lib/livekit";

// Get the roomName from the URL parameter
const { roomName } = Astro.params;

// Redirect if no room name is provided
if (!roomName) {
  return Astro.redirect("/");
}

// Check if the room actually exists and get display name
let roomExists = false;
let displayName = roomName; // Default to room ID

try {
  const rooms = await roomClientService.listRooms();
  const room = rooms.find((r) => r.name === roomName);

  if (room) {
    roomExists = true;
    // Parse metadata to get display name
    if (room.metadata) {
      try {
        const metadata = JSON.parse(room.metadata);
        displayName = metadata.displayName || roomName;
      } catch (e) {
        // If metadata parsing fails, use room name as fallback
      }
    }
  }
} catch (error) {
  console.error("Error checking if room exists:", error);
}

// Check if user is authenticated and has director role
const user = Astro.locals.user;
const isDirector = user?.roles?.includes("director") || false;
const username = user?.preferred_username || user?.name;
const isAuthenticated = !!user;
---

<BaseLayout title={`${displayName} - Live Stream`}>
  <RoomWrapper
    serverUrl={LIVEKIT_URL}
    roomName={roomName}
    roomDisplayName={displayName}
    roomExists={roomExists}
    isDirector={isDirector}
    username={username}
    isAuthenticated={isAuthenticated}
    client:only="react"
  />
</BaseLayout>
