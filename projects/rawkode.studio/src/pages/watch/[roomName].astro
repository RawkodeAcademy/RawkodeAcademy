---
import "@/styles/global.css";
import { LIVEKIT_URL } from "astro:env/server";
import LivekitRoom from "@/components/livestreams/room/livekit-room";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { roomClientService } from "@/lib/livekit";

// Get the roomName from the URL parameter
const { roomName } = Astro.params;

// Redirect if no room name is provided
if (!roomName) {
	return Astro.redirect("/");
}

// Check if the room actually exists
let roomExists = false;
try {
	const rooms = await roomClientService.listRooms();
	roomExists = rooms.some((room) => room.name === roomName);
} catch (error) {
	console.error("Error checking if room exists:", error);
}

// If room doesn't exist, redirect to home
if (!roomExists) {
	return Astro.redirect("/?error=room-not-found");
}

// Check if user is authenticated
const user = Astro.locals.user;

// For guests, we need to ensure they came from the invite page
// For authenticated users, we can use their user info
---

<BaseLayout title={`Watch: ${roomName} - Live Stream`}>
  <LivekitRoom
    serverUrl={LIVEKIT_URL}
    roomName={roomName}
    participantName={user?.preferred_username || user?.name}
    client:only="react"
    onLeaveRoom={(roomName: string) => {
      // Redirect to the invite page
      window.location.href = `/invite/${roomName}`;
    }}
  />

</BaseLayout>
