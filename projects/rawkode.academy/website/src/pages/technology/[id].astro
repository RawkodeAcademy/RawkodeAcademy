---
export const prerender = true;

import TopicHub from "@/components/technology/TopicHub.astro";
import Page from "@/wrappers/page.astro";
import type { GetStaticPaths } from "astro";
import { request } from "graphql-request";
import { GRAPHQL_ENDPOINT } from "astro:env/server";

// Define the Technology data type explicitly
export interface Technology {
	id: string;
	name: string;
	description: string;
	documentation?: string;
	website?: string;
	logo?: string;
	videos?: {
		id: string;
		title: string;
		thumbnailUrl: string;
		slug: string;
	}[];
}

interface GetTechnologiesResponse {
	getTechnologies: Technology[];
}

// Fetch all technologies to generate static paths
export const getStaticPaths = (async () => {
	const endpoint = GRAPHQL_ENDPOINT;

	try {
		console.log("Fetching technologies from GraphQL API...");

		// First, try to get a smaller batch to see if the API is working
		const testData = await request<GetTechnologiesResponse>(
			endpoint,
			`query GetTechnologies($limit: Int) {
			getTechnologies(limit: $limit) {
				id
				name
				description

				website
				documentation

				logo
	      videos {
	        id
	        title
					slug
	        thumbnailUrl
	      }
			}
		}`,
			{ limit: 10 },
		);

		console.log(
			`Test query successful, fetched ${testData.getTechnologies.length} technologies`,
		);

		// Now try the full query
		const data = await request<GetTechnologiesResponse>(
			endpoint,
			`query GetTechnologies($limit: Int) {
			getTechnologies(limit: $limit) {
				id
				name
				description

				website
				documentation

				logo
	      videos {
	        id
	        title
					slug
	        thumbnailUrl
	      }
			}
		}`,
			{ limit: 700 },
		);

		console.log(
			`Successfully fetched ${data.getTechnologies.length} technologies`,
		);

		return data.getTechnologies.map((tech) => ({
			params: { id: tech.id },
			props: { technology: tech },
		}));
	} catch (error) {
		console.error("Failed to fetch technologies:", error);
		if (error && typeof error === "object" && "response" in error) {
			console.error(
				"GraphQL Response:",
				JSON.stringify((error as any).response, null, 2),
			);
		}
		// Return empty array when API is not accessible (e.g., during CI builds)
		// This prevents technology pages from being generated but allows the build to succeed
		console.warn(
			"Technology pages will not be generated due to API unavailability",
		);
		return [];
	}
}) satisfies GetStaticPaths;

const { technology } = Astro.props as { technology: Technology };

const placeholderLogo = "/apple-touch-icon.png"; // Define a placeholder
---

<Page title={technology.name} description={technology.description}>
	<div class="flex flex-col gap-12 dark:bg-black dark:text-white min-h-screen">
		<style>
			@reference "@/styles/global.css";

			:root {
				--primary: #5f5ed7;
				--secondary: #00ceff;
			}

			.tech-header {
				background: linear-gradient(
					to bottom right,
					rgba(95, 94, 215, 0.1),
					rgba(0, 206, 255, 0.1)
				);
				border-bottom: 1px solid rgba(95, 94, 215, 0.2);
			}

			.tech-logo {
				@apply w-32 h-32 object-contain rounded-lg overflow-hidden;
				background: white;
				padding: 0.5rem;
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
				transition: transform 0.3s ease;
			}

			.tech-logo:hover {
				transform: scale(1.05);
			}

			.link-button {
				@apply inline-flex items-center px-4 py-2 rounded-lg text-white font-medium transition-all duration-300;
				background: linear-gradient(to right, var(--primary), var(--secondary));
				box-shadow: 0 4px 10px rgba(95, 94, 215, 0.3);
			}

			.link-button:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 15px rgba(95, 94, 215, 0.4);
			}

			.link-button svg {
				@apply w-5 h-5 mr-2;
			}

			.content-section {
				@apply bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8;
			}

			.section-title {
				@apply text-2xl font-bold mb-4 text-gray-900 dark:text-white;
				position: relative;
				padding-left: 1rem;
			}

			.section-title::before {
				content: "";
				position: absolute;
				left: 0;
				top: 0.25rem;
				bottom: 0.25rem;
				width: 4px;
				background: linear-gradient(
					to bottom,
					var(--primary),
					var(--secondary)
				);
				border-radius: 2px;
			}

			.empty-state {
				@apply flex flex-col items-center justify-center p-8 rounded-lg;
				background: rgba(95, 94, 215, 0.03);
				border: 2px dashed rgba(95, 94, 215, 0.1);
			}

			.empty-state svg {
				@apply w-16 h-16 mb-4 text-gray-400;
			}

			.content-card {
				@apply bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden transition-all duration-300;
				border: 1px solid rgba(95, 94, 215, 0.1);
			}

			.content-card:hover {
				transform: translateY(-5px);
				box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
			}

			.content-card img {
				@apply w-full h-40 object-cover;
			}

			.content-card .content {
				@apply p-4;
			}

			.content-card h3 {
				@apply text-lg font-semibold mb-2 text-gray-900 dark:text-white;
			}

			.content-card p {
				@apply text-gray-600 dark:text-gray-300 text-sm;
			}
		</style>

		<!-- Technology Header -->
		<section class="tech-header w-full px-4 py-8">
			<div class="max-w-7xl mx-auto">
				<div
					class="flex flex-col md:flex-row items-center md:items-start gap-8"
				>
					<img
						src={technology.logo ? technology.logo : placeholderLogo}
						alt={`${technology.name} Logo`}
						class="tech-logo"
						onerror={`this.onerror=null; this.src='${placeholderLogo}';`}
					/>
					<div class="flex-1">
						<h1
							class="text-4xl md:text-5xl font-bold mb-4 text-gray-900 dark:text-white"
						>
							{technology.name}
						</h1>
						<p class="text-lg text-gray-700 dark:text-gray-300 mb-6 max-w-3xl">
							{technology.description}
						</p>
						<div class="flex flex-wrap gap-4">
							{
								technology.website && (
									<a
										href={technology.website}
										target="_blank"
										rel="noopener noreferrer"
										class="link-button"
									>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											fill="none"
											viewBox="0 0 24 24"
											stroke-width="1.5"
											stroke="currentColor"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418"
											/>
										</svg>
										Official Website
									</a>
								)
							}
							{
								technology.documentation && (
									<a
										href={technology.documentation}
										target="_blank"
										rel="noopener noreferrer"
										class="link-button"
									>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											fill="none"
											viewBox="0 0 24 24"
											stroke-width="1.5"
											stroke="currentColor"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"
											/>
										</svg>
										Documentation
									</a>
								)
							}
						</div>
					</div>
				</div>
			</div>
		</section>

		<!-- Content Sections -->
		<div class="w-full px-4 pb-12">
			<div class="max-w-7xl mx-auto">
				<TopicHub 
					technologyId={technology.id}
					technologyName={technology.name}
					videos={technology.videos || []}
				/>
			</div>
		</div>
	</div>
</Page>
