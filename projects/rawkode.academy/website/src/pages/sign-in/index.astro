---
import MinimalLayout from "@/layouts/minimal.astro";
import Container from "@/components/ui/Container.vue";
import GlassPanel from "@/components/ui/GlassPanel.vue";

const error = Astro.url.searchParams.get("error");

const errorMessages: Record<string, string> = {
	"passkey-failed": "Passkey authentication failed. Please try again.",
	"auth-failed": "Authentication failed. Please try again.",
};
---

<MinimalLayout
	title="Sign In - Rawkode Academy"
	description="Sign in to Rawkode Academy to access exclusive content and features"
>
	<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
		<Container size="sm">
			<div class="text-center mb-8">
				<h1 class="text-4xl font-bold text-primary-content mb-2">
					Welcome Back
				</h1>
				<p class="text-secondary-content">
					Choose your preferred sign-in method
				</p>
			</div>

			{error && errorMessages[error] && (
				<div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl">
					<p class="text-red-800 dark:text-red-200 text-sm text-center">
						{errorMessages[error]}
					</p>
				</div>
			)}

			<GlassPanel variant="medium" blur="xl" padding="lg" rounded="2xl">
				<div class="space-y-4">
					<!-- GitHub OAuth -->
					<a
						href="/sign-in/github"
						class="w-full inline-flex items-center justify-center gap-3 rounded-xl px-6 py-4 text-base font-semibold tracking-wide text-white bg-[#24292e] hover:bg-[#1b1f23] border border-gray-700 hover:shadow-xl hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-gray-800 transition-all duration-200"
					>
						<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
							<path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd" />
						</svg>
						Continue with GitHub
					</a>

					<div class="relative">
						<div class="absolute inset-0 flex items-center">
							<div class="w-full border-t border-gray-300 dark:border-gray-700"></div>
						</div>
						<div class="relative flex justify-center text-sm">
							<span class="px-4 bg-white/80 dark:bg-gray-800/80 text-secondary-content">
								Or
							</span>
						</div>
					</div>

					<!-- Passkey Authentication -->
					<button
						id="passkey-btn"
						type="button"
						class="w-full inline-flex items-center justify-center gap-3 rounded-xl px-6 py-4 text-base font-semibold tracking-wide text-white bg-gradient-primary shadow-lg hover:shadow-xl border border-white/40 dark:border-white/10 hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary/60 transition-all duration-200"
					>
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
						</svg>
						<span id="passkey-text">Sign in with Passkey</span>
					</button>
				</div>

				<div class="mt-6 text-center">
					<p class="text-sm text-secondary-content">
						Don't have a passkey? Sign in with GitHub first, then register a passkey from your profile.
					</p>
				</div>
			</GlassPanel>
		</Container>
	</div>

	<script>
		import { createBetterAuthClient } from "@/lib/auth/better-auth-client";

		const passkeyBtn = document.getElementById("passkey-btn");
		const passkeyText = document.getElementById("passkey-text");

		if (passkeyBtn && passkeyText) {
			passkeyBtn.addEventListener("click", async () => {
				try {
					passkeyBtn.setAttribute("disabled", "true");
					passkeyText.textContent = "Authenticating...";

					// Get AUTH_SERVICE from runtime env
					// Note: This will only work if we can access the env from client-side
					// For now, we'll redirect to a server endpoint
					window.location.href = "/sign-in/passkey";
				} catch (error) {
					console.error("Passkey authentication failed:", error);
					window.location.href = "/sign-in?error=passkey-failed";
				}
			});
		}
	</script>
</MinimalLayout>
