---
import MinimalLayout from "@/layouts/minimal.astro";
import Container from "@/components/ui/Container.vue";
import GlassPanel from "@/components/ui/GlassPanel.vue";
import { createBetterAuthClient } from "@/lib/auth/better-auth-client";

// Check if user is already authenticated
const authService = Astro.locals.runtime?.env?.AUTH_SERVICE;

if (!authService) {
	return Astro.redirect("/sign-in?error=auth-failed");
}

// Create Better Auth client
const authClient = createBetterAuthClient(authService);

// Check for existing session
const { data: session } = await authClient.getSession({
	fetchOptions: {
		headers: Astro.request.headers,
	},
});

if (session) {
	// User is already signed in, redirect to home
	return Astro.redirect("/");
}
---

<MinimalLayout
	title="Passkey Sign In - Rawkode Academy"
	description="Sign in with your passkey"
>
	<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
		<Container size="sm">
			<div class="text-center mb-8">
				<h1 class="text-4xl font-bold text-primary-content mb-2">
					Passkey Sign In
				</h1>
				<p class="text-secondary-content">
					Use your registered passkey to sign in
				</p>
			</div>

			<GlassPanel variant="medium" blur="xl" padding="lg" rounded="2xl">
				<div class="space-y-6">
					<div class="text-center">
						<svg class="w-16 h-16 mx-auto mb-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
						</svg>

						<p class="text-secondary-content mb-6">
							Click the button below to authenticate with your passkey
						</p>

						<button
							id="passkey-auth-btn"
							type="button"
							class="w-full inline-flex items-center justify-center gap-3 rounded-xl px-6 py-4 text-base font-semibold tracking-wide text-white bg-gradient-primary shadow-lg hover:shadow-xl border border-white/40 dark:border-white/10 hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary/60 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
						>
							<span id="passkey-status">Authenticate with Passkey</span>
						</button>

						<div id="error-message" class="hidden mt-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
							<p class="text-red-800 dark:text-red-200 text-sm"></p>
						</div>
					</div>

					<div class="border-t border-gray-300 dark:border-gray-700 pt-6">
						<p class="text-sm text-secondary-content text-center mb-4">
							Don't have a passkey registered yet?
						</p>
						<a
							href="/sign-in"
							class="block text-center text-primary hover:text-primary/80 font-medium"
						>
							‚Üê Back to sign in options
						</a>
					</div>
				</div>
			</GlassPanel>

			<div class="mt-8 text-center">
				<details class="text-left">
					<summary class="text-sm text-secondary-content cursor-pointer hover:text-primary-content">
						What is a passkey?
					</summary>
					<div class="mt-4 text-sm text-secondary-content space-y-2">
						<p>
							Passkeys are a secure, password-free way to sign in using biometrics (Face ID, Touch ID, Windows Hello)
							or your device PIN. They're more secure than passwords and can't be phished.
						</p>
						<p>
							To use passkeys, you need to first sign in with GitHub and then register a passkey from your profile settings.
						</p>
					</div>
				</details>
			</div>
		</Container>
	</div>

	<script>
		// This script handles passkey authentication client-side
		// Note: This currently redirects to the auth service endpoint
		// In the future, we can implement full WebAuthn client-side handling

		const btn = document.getElementById("passkey-auth-btn") as HTMLButtonElement;
		const status = document.getElementById("passkey-status");
		const errorDiv = document.getElementById("error-message");
		const errorText = errorDiv?.querySelector("p");

		function showError(message: string) {
			if (errorDiv && errorText) {
				errorText.textContent = message;
				errorDiv.classList.remove("hidden");
			}
		}

		function hideError() {
			if (errorDiv) {
				errorDiv.classList.add("hidden");
			}
		}

		btn?.addEventListener("click", async () => {
			try {
				hideError();
				btn.disabled = true;
				if (status) status.textContent = "Authenticating...";

				// For now, we'll use a simple approach:
				// The auth service should have a passkey authentication endpoint
				// We'll redirect to it and let Better Auth handle the WebAuthn flow

				// Make a request to initiate passkey authentication
				// The middleware will forward this to AUTH_SERVICE
				const response = await fetch("/api/auth/passkey/authenticate", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
					},
				});

				if (!response.ok) {
					throw new Error("Failed to initiate passkey authentication");
				}

				const result = await response.json();

				if (result.error) {
					throw new Error(result.error.message || "Authentication failed");
				}

				// Success! Redirect to home
				window.location.href = "/";
			} catch (error) {
				console.error("Passkey authentication error:", error);
				showError(
					error instanceof Error
						? error.message
						: "Passkey authentication failed. Please try again or use GitHub sign-in."
				);
				btn.disabled = false;
				if (status) status.textContent = "Authenticate with Passkey";
			}
		});
	</script>
</MinimalLayout>
