---
export const prerender = false;

import VideoMetadata from "@/components/html/video-metadata.astro";
import Page from "@/wrappers/page.astro";
import { GRAPHQL_ENDPOINT } from "astro:env/server";

// Set cache headers for ISR
// Client cache: 5 minutes, Edge cache: 1 hour, Serve stale content for 24 hours during revalidation
Astro.response.headers.set(
	"Cache-Control",
	"public, max-age=300, s-maxage=3600, stale-while-revalidate=86400",
);
Astro.response.headers.set("CDN-Cache-Control", "public, max-age=3600");

// Add cache tags for targeted invalidation
Astro.response.headers.set("Cache-Tag", "videos-latest");

// Add build timestamp for debugging
Astro.response.headers.set("X-Build-Time", new Date().toISOString());

// Get page number from URL parameters (default to 1)
const currentPage = Math.max(1, parseInt(Astro.url.searchParams.get("page") || "1"));
const videosPerPage = 16;
const offset = (currentPage - 1) * videosPerPage;

const query = `
  query GetLatestVideos($limit: Int!, $offset: Int!) {
    getLatestVideos(limit: $limit, offset: $offset) {
      title
      thumbnailUrl
      duration
      slug
      publishedAt
      streamUrl
    }
  }
`;

interface Video {
	title: string;
	thumbnailUrl: string;
	duration: number;
	slug: string;
	publishedAt: string;
	streamUrl: string;
}

// Fetch videos for current page
let videos: Video[] = [];
let hasNextPage = false;

if (GRAPHQL_ENDPOINT) {
	try {
		const response = await fetch(GRAPHQL_ENDPOINT, {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
			},
			body: JSON.stringify({
				query,
				variables: { limit: videosPerPage + 1, offset }, // Fetch one extra to check if there's a next page
			}),
		});

		if (response.ok) {
			const result: any = await response.json();
			const fetchedVideos = result.data?.getLatestVideos || [];
			
			// If we got more than videosPerPage, there's a next page
			hasNextPage = fetchedVideos.length > videosPerPage;
			
			// Take only the videos for this page
			videos = fetchedVideos.slice(0, videosPerPage);
		} else {
			console.error(`Failed to fetch videos for page ${currentPage}:`, response.status);
		}
	} catch (error) {
		console.error(`Error fetching videos for page ${currentPage}:`, error);
	}
}

function formatDuration(seconds: number) {
	const hours = Math.floor(seconds / 3600);
	const minutes = Math.floor((seconds % 3600) / 60);
	const remainingSeconds = Math.floor(seconds % 60);

	if (hours > 0) {
		return `${hours}:${minutes.toString().padStart(2, "0")}:${remainingSeconds.toString().padStart(2, "0")}`;
	}
	return `${minutes}:${remainingSeconds.toString().padStart(2, "0")}`;
}

function formatDate(dateString: string) {
	return new Date(dateString).toLocaleDateString("en-US", {
		year: "numeric",
		month: "short",
		day: "numeric",
	});
}
---

<Page title={`Latest Videos - Page ${currentPage}`}>
  <VideoMetadata
    slot="extra-head"
    title={`Rawkode Academy Latest Videos - Page ${currentPage}`}
    description={`Browse the latest videos from Rawkode Academy, page ${currentPage}.`}
    isVideoList={true}
  />

  <section class="py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white sm:text-4xl">Latest Videos</h2>
        <p class="mt-4 text-lg text-gray-500 dark:text-gray-400">
          {currentPage > 1 ? `Page ${currentPage} of our latest videos` : "Our most recent video content"}
        </p>
      </div>
      
      <div class="mt-12 grid gap-8 md:grid-cols-2 lg:grid-cols-4">
        {videos.map((video: Video) => (
          <a href={`/watch/${video.slug}`} class="group">
            <div class="relative aspect-video">
              <img
                src={video.thumbnailUrl}
                alt={video.title}
                class="w-full h-full object-cover rounded-lg shadow-md transition-transform group-hover:scale-105"
                loading="lazy"
              />
              <div class="absolute bottom-2 right-2 bg-black bg-opacity-75 text-white px-2 py-1 rounded text-sm">
                {formatDuration(video.duration)}
              </div>
            </div>
            <div class="mt-4">
              <h3 class="text-lg font-medium text-gray-900 dark:text-white group-hover:text-indigo-600 dark:group-hover:text-indigo-400 line-clamp-2">
                {video.title}
              </h3>
              <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                {formatDate(video.publishedAt)}
              </p>
            </div>
          </a>
        ))}
      </div>
      
      {videos.length === 0 && (
        <div class="text-center mt-12">
          <p class="text-gray-500 dark:text-gray-400">No videos found for this page.</p>
        </div>
      )}

      <!-- Pagination Controls -->
      {(currentPage > 1 || hasNextPage) && (
        <div class="mt-12 flex justify-center items-center space-x-4">
          {currentPage > 1 && (
            <a
              href={currentPage === 2 ? "/watch/latest" : `/watch/latest?page=${currentPage - 1}`}
              class="px-4 py-2 text-sm font-medium text-indigo-600 dark:text-indigo-400 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
            >
              ← Previous
            </a>
          )}
          
          <span class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300">
            Page {currentPage}
          </span>
          
          {hasNextPage && (
            <a
              href={`/watch/latest?page=${currentPage + 1}`}
              class="px-4 py-2 text-sm font-medium text-indigo-600 dark:text-indigo-400 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
            >
              Next →
            </a>
          )}
        </div>
      )}
      
      {/* Link to browse all videos */}
      <div class="mt-8 text-center">
        <a
          href="/watch"
          class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-colors"
        >
          Browse All Videos
        </a>
      </div>
    </div>
  </section>
</Page>
