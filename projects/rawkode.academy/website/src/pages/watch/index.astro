---
export const prerender = false;

import Button from "@/components/common/Button.vue";
import VideoMetadata from "@/components/html/video-metadata.astro";
import Page from "@/wrappers/page.astro";
import { GRAPHQL_ENDPOINT } from "astro:env/server";

// Set cache headers for ISR
// Client cache: 5 minutes, Edge cache: 1 hour, Serve stale content for 24 hours during revalidation
Astro.response.headers.set(
	"Cache-Control",
	"public, max-age=300, s-maxage=3600, stale-while-revalidate=86400",
);
Astro.response.headers.set("CDN-Cache-Control", "public, max-age=3600");

// Add cache tags for targeted invalidation
Astro.response.headers.set(
	"Cache-Tag",
	"videos-page, videos-list, videos-latest",
);

// Add build timestamp for debugging
Astro.response.headers.set("X-Build-Time", new Date().toISOString());

// Get page number from URL parameters (default to 1)
const currentPage = Math.max(1, parseInt(Astro.url.searchParams.get("page") || "1"));
const videosPerPage = 16;
const offset = (currentPage - 1) * videosPerPage;

const latestVideosQuery = `
  query GetLatestVideos($limit: Int!, $offset: Int!) {
    getLatestVideos(limit: $limit, offset: $offset) {
      title
      thumbnailUrl
      duration
      slug
      publishedAt
      streamUrl
    }
  }
`;

// Fetch latest video for hero section with defensive error handling
interface Video {
	title: string;
	thumbnailUrl: string;
	duration: number;
	slug: string;
	publishedAt: string;
	streamUrl: string;
}

let latestVideo: Video | null = null;
let videos: Video[] = [];
let hasNextPage = false;

// Only fetch if GRAPHQL_ENDPOINT is available
if (GRAPHQL_ENDPOINT) {
	try {
		const controller = new AbortController();
		const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout
		
		// Fetch latest video for hero (only on page 1)
		if (currentPage === 1) {
			const heroResponse = await fetch(GRAPHQL_ENDPOINT, {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
				},
				body: JSON.stringify({
					query: `
					  query GetLatestVideo {
					    getLatestVideos(limit: 1) {
					      title
					      thumbnailUrl
					      duration
					      slug
					      publishedAt
					      streamUrl
					    }
					  }
					`,
				}),
				signal: controller.signal,
			});

			if (heroResponse.ok) {
				const heroResult: any = await heroResponse.json();
				if (heroResult.data?.getLatestVideos?.length > 0) {
					latestVideo = heroResult.data.getLatestVideos[0];
				}
			}
		}

		// Fetch videos for pagination
		const videosResponse = await fetch(GRAPHQL_ENDPOINT, {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
			},
			body: JSON.stringify({
				query: latestVideosQuery,
				variables: { limit: videosPerPage + 1, offset }, // Fetch one extra to check if there's a next page
			}),
			signal: controller.signal,
		});

		clearTimeout(timeoutId);

		if (videosResponse.ok) {
			const videosResult: any = await videosResponse.json();
			const fetchedVideos = videosResult.data?.getLatestVideos || [];
			
			// If we got more than videosPerPage, there's a next page
			hasNextPage = fetchedVideos.length > videosPerPage;
			
			// Take only the videos for this page
			videos = fetchedVideos.slice(0, videosPerPage);
		}
	} catch (error) {
		// Fail silently - hero will just show without featured video
		console.error('Failed to fetch videos:', error);
		latestVideo = null;
		videos = [];
	}
}

function formatDuration(seconds: number) {
	const hours = Math.floor(seconds / 3600);
	const minutes = Math.floor((seconds % 3600) / 60);
	const remainingSeconds = Math.floor(seconds % 60);

	if (hours > 0) {
		return `${hours}:${minutes.toString().padStart(2, "0")}:${remainingSeconds.toString().padStart(2, "0")}`;
	}
	return `${minutes}:${remainingSeconds.toString().padStart(2, "0")}`;
}

function formatDate(dateString: string) {
	return new Date(dateString).toLocaleDateString("en-US", {
		year: "numeric",
		month: "short",
		day: "numeric",
	});
}
---

<Page title={currentPage > 1 ? `Videos - Page ${currentPage}` : "Videos"}>
	<VideoMetadata
		slot="extra-head"
		title={currentPage > 1 ? `Rawkode Academy Videos - Page ${currentPage}` : "Rawkode Academy Videos"}
		description={currentPage > 1 ? `Browse videos from Rawkode Academy, page ${currentPage}.` : "Explore our collection of educational videos about cloud native technologies, development practices, and more."}
		isVideoList={true}
	/>

	<!-- Compact Hero Section with Featured Video (only on page 1) -->
	{currentPage === 1 && (
	<section class="relative overflow-hidden bg-gradient-to-b from-gray-50 to-white dark:from-gray-900 dark:to-gray-800">
		<!-- Background decoration -->
		<div class="absolute inset-0 pointer-events-none">
			<div class="absolute top-0 left-1/4 w-96 h-96 bg-purple-200 dark:bg-purple-900 rounded-full opacity-20 blur-3xl"></div>
			<div class="absolute bottom-0 right-1/4 w-96 h-96 bg-blue-200 dark:bg-blue-900 rounded-full opacity-20 blur-3xl"></div>
		</div>
		
		<div class="relative z-10 container mx-auto px-4 py-12">
			<div class="max-w-6xl mx-auto">
				<!-- Header Content -->
				<div class="text-center mb-12">
					<div class="mb-4">
						<span class="px-3 py-1 text-sm font-semibold rounded-full bg-primary text-white shadow-lg">Video Library</span>
					</div>
					
					<h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 dark:text-white mb-6">
						Live Streams & Video Content
					</h1>
					
					<p class="text-lg md:text-xl text-gray-600 dark:text-gray-300 mb-8 max-w-3xl mx-auto">
						Watch and learn from our extensive collection of cloud native tutorials, live coding sessions, and technical deep dives.
					</p>
					
					<div class="flex flex-wrap items-center justify-center gap-6 text-sm text-gray-500 dark:text-gray-400 mb-8">
						<span>500+ Hours</span>
						<span>Weekly Streams</span>
						<span>HD Quality</span>
					</div>
				</div>

				<!-- Featured Latest Video -->
				{latestVideo && (
					<div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-gray-200 dark:border-gray-700">
						<div class="flex flex-col lg:flex-row">
							<!-- Video Thumbnail -->
							<div class="lg:w-1/2 relative">
								<div class="absolute inset-0 bg-black bg-opacity-30 z-10 flex items-center justify-center group-hover:bg-opacity-50 transition-all">
									<div class="w-16 h-16 bg-white bg-opacity-90 rounded-full flex items-center justify-center">
										<svg class="w-6 h-6 text-gray-800 ml-1" fill="currentColor" viewBox="0 0 20 20">
											<path d="M8 5v10l8-5-8-5z"/>
										</svg>
									</div>
								</div>
								
								<img
									src={latestVideo.thumbnailUrl}
									alt={latestVideo.title}
									class="w-full h-64 lg:h-full object-cover"
								/>

								<div class="absolute top-4 left-4 z-20">
									<span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-600 text-white shadow-lg">
										Latest Video
									</span>
								</div>

								<div class="absolute bottom-4 right-4 z-20">
									<span class="px-2 py-1 text-xs font-semibold rounded bg-black bg-opacity-75 text-white">
										{formatDuration(latestVideo.duration)}
									</span>
								</div>
							</div>

							<!-- Video Content -->
							<div class="lg:w-1/2 p-8 flex flex-col justify-center">
								<h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white mb-4">
									{latestVideo.title}
								</h2>

								<div class="flex items-center text-gray-500 dark:text-gray-400 text-sm mb-6">
									<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 002 2z" />
									</svg>
									Published {formatDate(latestVideo.publishedAt)}
								</div>

								<div class="flex gap-4">
									<Button href={`/watch/${latestVideo.slug}`} variant="primary" size="lg">
										<svg slot="icon-left" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
											<path d="M8 5v10l8-5-8-5z"/>
										</svg>
										Watch Now
									</Button>
								</div>
							</div>
						</div>
					</div>
				)}

				<!-- Fallback for when no featured video is available -->
				{!latestVideo && (
					<div class="text-center">
						<Button href="#latest-videos" variant="primary" size="lg">Watch Latest</Button>
					</div>
				)}
			</div>
		</div>
	</section>
	)}

	<!-- Latest Videos Section with Pagination -->
	<section class="py-12">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="text-center">
				<h2 class="text-3xl font-extrabold text-gray-900 dark:text-white sm:text-4xl">
					{currentPage > 1 ? `Latest Videos - Page ${currentPage}` : "Latest Videos"}
				</h2>
				<p class="mt-4 text-lg text-gray-500 dark:text-gray-400">
					{currentPage > 1 ? `Page ${currentPage} of our latest videos` : "Stay up to date with our newest content"}
				</p>
			</div>
			
			<div class="mt-12 grid gap-8 md:grid-cols-2 lg:grid-cols-4">
				{videos.map((video: Video) => (
					<a href={`/watch/${video.slug}`} class="group">
						<div class="relative aspect-video">
							<img
								src={video.thumbnailUrl}
								alt={video.title}
								class="w-full h-full object-cover rounded-lg shadow-md transition-transform group-hover:scale-105"
								loading="lazy"
							/>
							<div class="absolute bottom-2 right-2 bg-black bg-opacity-75 text-white px-2 py-1 rounded text-sm">
								{formatDuration(video.duration)}
							</div>
						</div>
						<div class="mt-4">
							<h3 class="text-lg font-medium text-gray-900 dark:text-white group-hover:text-indigo-600 dark:group-hover:text-indigo-400 line-clamp-2">
								{video.title}
							</h3>
							<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
								{formatDate(video.publishedAt)}
							</p>
						</div>
					</a>
				))}
			</div>
			
			{videos.length === 0 && (
				<div class="text-center mt-12">
					<p class="text-gray-500 dark:text-gray-400">No videos found for this page.</p>
				</div>
			)}

			<!-- Pagination Controls -->
			{(currentPage > 1 || hasNextPage) && (
				<div class="mt-12 flex justify-center items-center space-x-4">
					{currentPage > 1 && (
						<a
							href={currentPage === 2 ? "/watch" : `/watch?page=${currentPage - 1}`}
							class="px-4 py-2 text-sm font-medium text-indigo-600 dark:text-indigo-400 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
						>
							← Previous
						</a>
					)}
					
					<span class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300">
						Page {currentPage}
					</span>
					
					{hasNextPage && (
						<a
							href={`/watch?page=${currentPage + 1}`}
							class="px-4 py-2 text-sm font-medium text-indigo-600 dark:text-indigo-400 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
						>
							Next →
						</a>
					)}
				</div>
			)}
		</div>
	</section>
</Page>
