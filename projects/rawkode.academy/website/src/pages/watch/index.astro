---
export const prerender = false;

import { getCollection } from "astro:content";
import { GRAPHQL_ENDPOINT } from "astro:env/server";
import { request, gql } from "graphql-request";
import FeaturedContent from "@/components/common/FeaturedContent.astro";
import VideoMetadata from "@/components/html/video-metadata.astro";
import VideoFeed from "@/components/video/video-feed.astro";
import Page from "@/wrappers/page.astro";

// Set cache headers for ISR
// Client cache: 5 minutes, Edge cache: 1 hour, Serve stale content for 24 hours during revalidation
Astro.response.headers.set(
	"Cache-Control",
	"public, max-age=300, s-maxage=3600, stale-while-revalidate=86400",
);
Astro.response.headers.set("CDN-Cache-Control", "public, max-age=3600");

// Add cache tags for targeted invalidation
Astro.response.headers.set(
	"Cache-Tag",
	"videos-page, videos-list, videos-latest",
);

// Add build timestamp for debugging
Astro.response.headers.set("X-Build-Time", new Date().toISOString());

// Get page parameter from URL
const page = parseInt(Astro.url.searchParams.get("page") || "1", 10);
const videosPerPage = 16;

// Load videos from local content collection
const allVideos = (await getCollection("videos")).map((v) => v.data);
// Sort newest first
allVideos.sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime());

// Featured: first item on page 1
const featuredVideo = page === 1 ? allVideos[0] ?? null : null;
let featuredDuration: number | null = null;
if (featuredVideo) {
  try {
    const q = gql`query GetVideoBySlug($slug: String!){ getVideoBySlug(slug:$slug){ duration } }`;
    const r: { getVideoBySlug?: { duration?: number | null } } = await request(GRAPHQL_ENDPOINT, q, { slug: featuredVideo.slug });
    featuredDuration = r.getVideoBySlug?.duration ?? null;
  } catch {}
}

// Pagination
const start = page === 1 ? 1 : (page - 1) * videosPerPage;
const end = start + videosPerPage;
const feedVideos = allVideos.slice(start, end).map((v) => ({
  id: v.id,
  title: v.title,
  description: v.description,
  slug: v.slug,
  publishedAt: (v.publishedAt instanceof Date ? v.publishedAt.toISOString() : String(v.publishedAt)),
}));
const hasNextPage = end < allVideos.length;
---

<Page title="Videos">
	{page > 1 && (
		<Fragment slot="extra-head">
			<meta name="robots" content="noindex,follow" />
		</Fragment>
	)}
	<VideoMetadata
		slot="extra-head"
		title="Rawkode Academy Videos"
		description="Explore our collection of educational videos about cloud native technologies, development practices, and more."
		isVideoList={true}
	/>

	<!-- Featured Content Section -->
	{featuredVideo && (
		<FeaturedContent
			type="video"
			title={featuredVideo.title}
			description={featuredVideo.description}
			thumbnailUrl={`https://content.rawkode.academy/videos/${featuredVideo.id}/thumbnail.jpg`}
			thumbnailAlt={`Thumbnail for ${featuredVideo.title}`}
			date={(featuredVideo.publishedAt instanceof Date ? featuredVideo.publishedAt.toISOString() : String(featuredVideo.publishedAt))}
			duration={featuredDuration !== null ? String(featuredDuration) : undefined}
			href={`/watch/${featuredVideo.slug}`}
			ctaText="Watch Now"
		/>
	)}
 
 	<div id="latest-videos" class="flex flex-col gap-12">
 		<VideoFeed
			title={page === 1 ? "Latest Videos" : `Videos - Page ${page}`}
			description={page === 1 ? "Stay up to date with our newest content" : "Browse our video collection"}
			videos={feedVideos}
		/>

		{/* Pagination controls */}
		<div class="flex justify-center items-center gap-4 mt-8">
			{page > 1 && (
				<a
					href={page === 2 ? "/watch" : `/watch?page=${page - 1}`}
					class="inline-block px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 dark:hover:bg-gray-600"
				>
					← Previous
				</a>
			)}
			
			<span class="px-4 py-2 text-gray-700 dark:text-gray-300">
				Page {page}
			</span>
			
			{hasNextPage && (
				<a
					href={`/watch?page=${page + 1}`}
					class="inline-block px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700"
				>
					Next →
				</a>
			)}
		</div>
	</div>
</Page>
