---
import { getCollection, getEntry } from "astro:content";
import Breadcrumb from "@/components/breadcrumb/Breadcrumb.astro";
// ShareButton is now internal to VideoReactions
import VideoMetadata from "@/components/html/video-metadata.astro";
import RelatedVideos from "@/components/video/RelatedVideos.astro";
import VideoPlayer from "@/components/video/player.vue";
import VideoReactions from "@/components/video/VideoReactions.astro";
import VideoContentTabs from "@/components/video/video-content-tabs.vue";
import Page from "@/wrappers/page.astro";
import { Marked } from "marked";
import { resolveTechnologyIconUrl } from "@/utils/resolve-technology-icon";

export const prerender = false;

// Get the slug from URL params
const { slug } = Astro.params;

// First, try to get video from the collection (build-time data)
const videos = await getCollection("videos");
let video: (typeof videos)[0] | undefined = videos.find(
	(v) => v.data.slug === slug,
);

// Handle 404 case if still not found
if (!video) {
	return Astro.redirect("/404");
}

// Set cache headers for ISR
// Individual video pages can cache longer since they change less frequently
// Client cache: 10 minutes, Edge cache: 2 hours, Serve stale for 48 hours
Astro.response.headers.set(
	"Cache-Control",
	"public, max-age=600, s-maxage=7200, stale-while-revalidate=172800",
);
Astro.response.headers.set("CDN-Cache-Control", "public, max-age=7200");

// Add cache tags for targeted invalidation
// Use video-specific tag to purge individual videos
Astro.response.headers.set(
	"Cache-Tag",
	`video-${video.data.slug}, videos-page, video-detail`,
);

// Add build timestamp for debugging
Astro.response.headers.set("X-Build-Time", new Date().toISOString());

// Configure Marked to handle single newlines as breaks
const marked = new Marked({
	breaks: true,
	gfm: true,
});
// Convert literal \n escape sequences to actual newlines before processing
const processedDescription = video.data.description.replace(/\\n/g, "\n");
const renderedDescriptionHtml = marked.parse(processedDescription);

// Fetch chapters for key moments (clips) JSON-LD
type Chapter = { startTime: number; title: string };
let clips: Array<{ name: string; startOffset: number; endOffset?: number }> =
	[];
const durationSec: number | null =
	typeof video.data.duration === "number" ? video.data.duration : null;

const chapterSource: Chapter[] = Array.isArray(video.data.chapters)
	? (video.data.chapters as Chapter[]).map((c) => ({
			title: c.title,
			startTime: Math.max(0, Math.floor(c?.startTime ?? 0)),
		}))
	: [];

if (chapterSource.length > 0) {
	chapterSource.sort((a, b) => a.startTime - b.startTime);
	clips = chapterSource.map((c, i) => {
		const next = chapterSource[i + 1];
		return {
			name: c.title,
			startOffset: c.startTime,
			...(next ? { endOffset: next.startTime } : {}),
		};
	});
}

// Format date to readable format
const formatDate = (date: Date | string) => {
	const d = typeof date === "string" ? new Date(date) : date;
	return d.toLocaleDateString("en-US", {
		year: "numeric",
		month: "long",
		day: "numeric",
	});
};

// Resolve referenced show and technologies
const showRef = video.data.show;
const showId =
	typeof showRef === "string"
		? showRef
		: showRef && typeof showRef === "object" && "id" in showRef
			? (showRef as { id: string }).id
			: null;
const showEntry = showId ? await getEntry("shows", showId) : null;
const techEntries = Array.isArray(video.data.technologies)
	? (
			await Promise.all(
				(video.data.technologies as string[]).map(async (id) => {
					try {
						return await getEntry("technologies", id);
					} catch {
						return null;
					}
				}),
			)
		).filter((t): t is NonNullable<typeof t> => Boolean(t))
	: [];

const breadcrumbElements = showEntry
	? [
			{ title: "Home", link: "/" },
			{ title: "Videos", link: "/watch" },
			{ title: showEntry.data.name, link: `/shows/${showEntry.id}` },
			{ title: video.data.title, link: `/watch/${video.data.slug}` },
		]
	: [
			{ title: "Home", link: "/" },
			{ title: "Videos", link: "/watch" },
			{ title: video.data.title, link: `/watch/${video.data.slug}` },
		];

const thumbnailUrl = `https://content.rawkode.academy/videos/${video.data.videoId}/thumbnail.jpg`;
const streamUrl = `https://content.rawkode.academy/videos/${video.data.videoId}/stream.m3u8`;
---

<Page
	title={video.data.title}
	description={video.data.description}
	useImageDirectly={true}
	image={{ image: new URL(thumbnailUrl) }}
>
	<VideoMetadata
		slot="extra-head"
		title={video.data.title}
		description={video.data.description}
		thumbnailUrl={thumbnailUrl}
		publishedAt={(video.data.publishedAt instanceof Date ? video.data.publishedAt.toISOString() : String(video.data.publishedAt))}
		duration={durationSec ?? 0}
		streamUrl={streamUrl}
		clips={clips}
	/>
	<div class="min-h-screen bg-gray-50 dark:bg-black">
		<div class="container mx-auto px-4 py-6 lg:py-8 max-w-screen-2xl">
			{/* Breadcrumb */}
			<div class="mb-6">
				<Breadcrumb elements={breadcrumbElements} />
			</div>
			
			{/* Hero Section with Title */}
			<div class="mb-8">
				<h1 class="text-4xl lg:text-5xl font-bold text-gray-900 dark:text-white mb-4 tracking-tight">{video.data.title}</h1>
				<div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 dark:text-gray-400">
					<time datetime={video.data.publishedAt instanceof Date ? video.data.publishedAt.toISOString() : String(video.data.publishedAt)} class="flex items-center gap-2">
						<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
						</svg>
						{formatDate(video.data.publishedAt)}
					</time>
					<span class="text-gray-400 dark:text-gray-600">â€¢</span>
					<span>{Math.floor((durationSec ?? 0) / 60)} min watch</span>
				</div>
			</div>

			{/* Main Content - Single Column */}
			<div class="max-w-4xl mx-auto">
				{/* Video Player */}
				<div class="relative w-full aspect-video rounded-xl overflow-hidden bg-black shadow-2xl">
					<VideoPlayer
						client:only="vue"
						video={video.data.videoId}
						thumbnailUrl={thumbnailUrl}
					/>
				</div>

				{/* Video Controls & Social Features */}
				<div class="mt-4">
					<VideoReactions
						server:defer
						videoId={video.data.videoId}
					/>
					{/* ShareButton will be managed internally by VideoReactions */}
				</div>

				{/* Tabbed Content: Description & Transcript */}
				<div class="mt-6">
					<VideoContentTabs
						client:idle
						descriptionHtml={renderedDescriptionHtml}
						videoId={video.data.videoId}
					/>
				</div>

				{/* Technologies Section */}
				{techEntries.length > 0 && (
					<div class="mt-6">
						<h3 class="text-base font-medium text-gray-700 dark:text-gray-300 mb-3">Technologies used in this video</h3>
						<div class="flex flex-wrap gap-2">
							{techEntries.map((tech) => (
								<a
									Astro.key={tech.id}
									href={`/technology/${tech.id.replace(/\/index$/, '')}`}
									class="inline-flex items-center gap-2 px-3 py-2 bg-white/40 dark:bg-gray-800/40 backdrop-blur-md border border-white/40 dark:border-gray-700/40 hover:bg-white/60 dark:hover:bg-gray-700/60 rounded-lg shadow-md hover:shadow-lg hover:scale-105 transition-all duration-200 group"
								>
									<div class="w-6 h-6 relative overflow-hidden rounded">
										<img
											src={resolveTechnologyIconUrl(tech.id, tech.data.icon) || '/apple-touch-icon.png'}
											alt={tech.data.name}
											class="w-full h-full object-contain"
											onerror="this.onerror=null; this.src='/apple-touch-icon.png'"
										/>
									</div>
									<span class="text-sm font-medium text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-white">
										{tech.data.name}
									</span>
									<svg class="w-4 h-4 text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-200 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
									</svg>
								</a>
							))}
						</div>
					</div>
				)}

			</div>
			
			{/* Related Videos */}
			<RelatedVideos currentVideo={video} limit={4} />
			</div>
		</div>
	</div>
</Page>

<style>
	/* Professional typography for prose content */
	.prose {
		line-height: 1.75;
		color: rgb(55 65 81);
	}

	.dark .prose {
		color: rgb(209 213 219);
	}

	.prose :global(p) {
		margin-bottom: 1.5rem;
	}

	/* Clean, professional link styles */
	.prose :global(a) {
		color: rgb(59 130 246);
		text-decoration: underline;
		text-underline-offset: 2px;
		text-decoration-thickness: 1px;
		transition: all 0.2s ease;
	}

	.prose :global(a:hover) {
		color: rgb(37 99 235);
		text-decoration-thickness: 2px;
	}

	.dark .prose :global(a) {
		color: rgb(96 165 250);
	}

	.dark .prose :global(a:hover) {
		color: rgb(147 197 253);
	}
</style>
