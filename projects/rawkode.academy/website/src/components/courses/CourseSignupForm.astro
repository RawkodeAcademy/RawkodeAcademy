---
import CourseSignupFormClient from "./CourseSignupFormClient.vue";
import { isSubscribedToAudience } from "@/server/subscriptions";

export const partial = true;

type Props = {
	courseId: string;
	courseTitle: string;
	signupConfig: {
		audienceId: string;
		sponsor?: string | undefined;
		sponsorAudienceId?: string | undefined;
		allowSponsorContact: boolean;
	};
	deferSubscriptionCheck?: boolean | undefined;
};

const {
	courseId,
	courseTitle,
	signupConfig,
	deferSubscriptionCheck = false,
} = Astro.props;
const user = Astro.locals?.user;

const { audienceId, sponsor, sponsorAudienceId, allowSponsorContact } =
	signupConfig;

// Check if user is already subscribed using the shared helper (unless deferred to client)
let isAlreadySubscribed: boolean | undefined;
if (!deferSubscriptionCheck) {
	isAlreadySubscribed = await isSubscribedToAudience(
		audienceId,
		user?.email,
		Astro.session,
	);
}
---

<CourseSignupFormClient
	courseId={courseId}
	courseTitle={courseTitle}
	audienceId={audienceId}
	sponsor={sponsor}
	sponsorAudienceId={sponsorAudienceId}
	allowSponsorContact={allowSponsorContact}
	userEmail={user?.email}
	isAlreadySubscribed={isAlreadySubscribed}
	deferSubscriptionCheck={deferSubscriptionCheck}
	client:load
/>