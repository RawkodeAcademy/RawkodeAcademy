---
import AppLayout from "../components/AppLayout.astro";
import InteractiveStoryMap from "../components/InteractiveStoryMap.tsx";
import { getCollection } from "astro:content";

const personas = await getCollection("personas");
const activities = await getCollection("activities");
const stories = await getCollection("stories");
const actions = await getCollection("actions");
const features = await getCollection("features");

// Debug logging
console.log("Collections loaded:", {
	personas: personas.length,
	activities: activities.length,
	stories: stories.length,
	actions: actions.length,
	features: features.length,
});

// Process collections to match the format expected by the React component
const personasWithId = personas.map((p) => ({ ...p, id: p.slug }));
const featuresWithId = features.map((f) => ({ ...f, id: f.slug }));

const activitiesWithId = activities.map((activity) => ({
	...activity,
	id: activity.slug,
	data: {
		...activity.data,
		personas: activity.data.personas.map((p) => p.slug || p.id),
	},
}));

const storiesWithId = stories.map((story) => ({
	...story,
	id: story.slug,
	data: {
		...story.data,
		personaId: story.data.personaId.slug,
		activityId: story.data.activityId.slug,
		featureId: story.data.featureId?.slug,
	},
}));

const actionsWithId = actions.map((action) => ({
	...action,
	id: action.slug,
	data: {
		...action.data,
		personaId: action.data.personaId.slug,
		activityId: action.data.activityId.slug,
		storyId: action.data.storyId?.slug,
	},
}));
---

<AppLayout title="Story Map - ForgePoint">
  <div style="height: calc(100vh - 48px); width: 100%; overflow: hidden;">
    <InteractiveStoryMap 
      personas={personasWithId}
      activities={activitiesWithId} 
      stories={storiesWithId}
      actions={actionsWithId}
      features={featuresWithId}
      client:load
    />
  </div>
</AppLayout>