WEBVTT

NOTE
Transcription provided by Deepgram
Request Id: 7e21aa7e-bd92-49d5-a6bf-b12a1e38ed99
Created: 2025-04-29T13:18:35.596Z
Duration: 610.30817
Channels: 1

00:00:00.640 --> 00:00:03.439
<v Speaker 0>Hello, and welcome back to Rawkode

00:00:03.439 --> 00:00:04.400
<v Speaker 0>Academy.

00:00:04.880 --> 00:00:07.279
<v Speaker 0>I'm your host, David Flanagan. And today, we're

00:00:07.279 --> 00:00:10.559
<v Speaker 0>gonna be continuing our complete guide to Parca.

00:00:11.200 --> 00:00:12.240
<v Speaker 0>Today's tutorial

00:00:13.125 --> 00:00:15.764
<v Speaker 0>we'll be configuring the scrape config to use

00:00:15.764 --> 00:00:17.765
<v Speaker 0>Kubernetes service discovery.

00:00:18.085 --> 00:00:18.965
<v Speaker 0>But first,

00:00:19.365 --> 00:00:20.005
<v Speaker 0>why?

00:00:21.525 --> 00:00:23.445
<v Speaker 0>Well, so far in this course, we have

00:00:23.445 --> 00:00:25.605
<v Speaker 0>deployed to Parca server and seen that it

00:00:25.605 --> 00:00:28.100
<v Speaker 0>doesn't really do much by default. It's a

00:00:28.100 --> 00:00:30.180
<v Speaker 0>database that needs data.

00:00:31.300 --> 00:00:33.140
<v Speaker 0>To provide that data, we've been using the

00:00:33.140 --> 00:00:34.180
<v Speaker 0>Parca agent,

00:00:34.260 --> 00:00:35.700
<v Speaker 0>which is fantastic.

00:00:35.700 --> 00:00:37.940
<v Speaker 0>You deploy the Parca agent to your cluster.

00:00:37.940 --> 00:00:40.660
<v Speaker 0>It runs as a daemon set, discovers the

00:00:40.660 --> 00:00:43.915
<v Speaker 0>processes on the nodes using eBPF

00:00:43.915 --> 00:00:46.395
<v Speaker 0>and gets you loads of amazing profile information

00:00:46.395 --> 00:00:49.435
<v Speaker 0>to get started with no with little to

00:00:49.435 --> 00:00:50.635
<v Speaker 0>no effort.

00:00:51.435 --> 00:00:52.235
<v Speaker 0>However,

00:00:52.555 --> 00:00:53.434
<v Speaker 0>sometimes

00:00:53.595 --> 00:00:55.835
<v Speaker 0>you may want to provide your own p

00:00:55.835 --> 00:00:56.475
<v Speaker 0>professor information.

00:00:57.220 --> 00:00:59.620
<v Speaker 0>Some languages like Node. Js and Go have

00:00:59.620 --> 00:01:02.100
<v Speaker 0>fantastic support for stuff and an even more

00:01:02.100 --> 00:01:04.500
<v Speaker 0>information from the runtimes themselves.

00:01:05.140 --> 00:01:07.620
<v Speaker 0>So what if we want to consume that?

00:01:08.100 --> 00:01:10.340
<v Speaker 0>Well, we can configure the Parca server

00:01:11.355 --> 00:01:14.155
<v Speaker 0>with scrape configs, scrape targets,

00:01:15.115 --> 00:01:16.795
<v Speaker 0>much like Prometheus itself.

00:01:16.955 --> 00:01:18.875
<v Speaker 0>And in fact, it allows us to use

00:01:18.875 --> 00:01:21.995
<v Speaker 0>the service discovery modules from the Prometheus package,

00:01:22.395 --> 00:01:24.395
<v Speaker 0>and the configuration is identical.

00:01:25.570 --> 00:01:27.650
<v Speaker 0>So in today's video, we're going to change

00:01:27.650 --> 00:01:30.290
<v Speaker 0>the config of Parca, add a scrape config

00:01:30.290 --> 00:01:32.370
<v Speaker 0>using Kubernetes service discovery

00:01:32.450 --> 00:01:35.410
<v Speaker 0>to filter for annotations that we just saved.

00:01:36.210 --> 00:01:38.050
<v Speaker 0>I have a workload deployed to my cluster,

00:01:38.050 --> 00:01:40.465
<v Speaker 0>which is influx d b two. I'm using

00:01:40.465 --> 00:01:42.545
<v Speaker 0>influx d b two because it ships by

00:01:42.545 --> 00:01:45.025
<v Speaker 0>default with a p professor endpoint.

00:01:45.985 --> 00:01:48.145
<v Speaker 0>We're going to configure Parca to scrape that

00:01:48.145 --> 00:01:50.465
<v Speaker 0>endpoint and give us all the information.

00:01:52.030 --> 00:01:53.390
<v Speaker 0>So let's take a look.

00:01:54.590 --> 00:01:58.109
<v Speaker 0>Okay. So let's set the scene. First,

00:01:59.070 --> 00:02:00.990
<v Speaker 0>we have a default namespace,

00:02:01.470 --> 00:02:02.670
<v Speaker 0>box d b two.

00:02:05.715 --> 00:02:08.355
<v Speaker 0>We also have Parca namespace.

00:02:10.275 --> 00:02:11.795
<v Speaker 0>Parca deployed.

00:02:12.435 --> 00:02:14.915
<v Speaker 0>Please note, there is no Parca agent. Meaning,

00:02:14.915 --> 00:02:17.875
<v Speaker 0>currently, Parca has no data whatsoever.

00:02:18.990 --> 00:02:21.630
<v Speaker 0>This is the default install of InvoiceDB two.

00:02:21.630 --> 00:02:23.150
<v Speaker 0>Nothing has been tweaked. And this is the

00:02:23.150 --> 00:02:26.270
<v Speaker 0>default install of Parca. Nothing has been tweaked.

00:02:27.550 --> 00:02:30.510
<v Speaker 0>We are running a port forward and another

00:02:30.510 --> 00:02:33.870
<v Speaker 0>tab to the Parca UI or the Parca

00:02:33.870 --> 00:02:34.270
<v Speaker 0>server.

00:02:36.965 --> 00:02:38.485
<v Speaker 0>So we can pop open

00:02:38.645 --> 00:02:40.325
<v Speaker 0>and hit refresh a whole bunch of times

00:02:40.325 --> 00:02:42.565
<v Speaker 0>and see that nothing has changed. The Parca

00:02:42.565 --> 00:02:44.965
<v Speaker 0>server has not received any data.

00:02:45.605 --> 00:02:47.045
<v Speaker 0>And if we come to targets,

00:02:47.365 --> 00:02:48.965
<v Speaker 0>there are no targets available.

00:02:49.620 --> 00:02:52.260
<v Speaker 0>Our Parca has nothing to scrape, and nothing

00:02:52.260 --> 00:02:54.260
<v Speaker 0>has been written via the push model and

00:02:54.260 --> 00:02:55.060
<v Speaker 0>the agent.

00:02:55.700 --> 00:02:57.780
<v Speaker 0>So how do we get started?

00:02:59.300 --> 00:03:02.100
<v Speaker 0>Well, we can modify the Parca config map.

00:03:02.445 --> 00:03:04.925
<v Speaker 0>This provides everything that we need to modify

00:03:04.925 --> 00:03:07.965
<v Speaker 0>and provide our own scrape target configuration.

00:03:10.365 --> 00:03:11.165
<v Speaker 0>Personally,

00:03:11.565 --> 00:03:13.885
<v Speaker 0>I've already prepared a config map for us

00:03:13.885 --> 00:03:14.765
<v Speaker 0>to take a look at.

00:03:19.450 --> 00:03:20.890
<v Speaker 0>It's a little bit bigger.

00:03:21.609 --> 00:03:23.930
<v Speaker 0>And we'll see here, this is what the

00:03:23.930 --> 00:03:26.810
<v Speaker 0>default Parca conflict map looks like. It just

00:03:26.810 --> 00:03:29.465
<v Speaker 0>configures the bucket, in this case, file system

00:03:29.465 --> 00:03:31.545
<v Speaker 0>and a directory of where to store its

00:03:31.545 --> 00:03:32.185
<v Speaker 0>data.

00:03:32.665 --> 00:03:35.865
<v Speaker 0>We can confirm this from the command line

00:03:36.665 --> 00:03:39.305
<v Speaker 0>where we can see get config map Parca

00:03:39.305 --> 00:03:40.745
<v Speaker 0>dash o channel.

00:03:41.740 --> 00:03:44.140
<v Speaker 0>You will see the default configuration.

00:03:50.060 --> 00:03:52.940
<v Speaker 0>But we can change this. Right? So we

00:03:52.940 --> 00:03:55.100
<v Speaker 0>can say, let's add a script config.

00:03:55.825 --> 00:03:58.145
<v Speaker 0>Now remember, this is just Prometheus

00:03:58.145 --> 00:04:01.185
<v Speaker 0>format for configuration. If you have configured Prometheus

00:04:01.185 --> 00:04:04.385
<v Speaker 0>before to do service discovery and configure dynamic

00:04:04.385 --> 00:04:06.785
<v Speaker 0>script targets, it's very much the same for

00:04:06.785 --> 00:04:07.185
<v Speaker 0>Parca.

00:04:08.440 --> 00:04:10.280
<v Speaker 0>We can give our job a name here.

00:04:10.280 --> 00:04:12.120
<v Speaker 0>We're calling it PPROF endpoints,

00:04:12.360 --> 00:04:14.520
<v Speaker 0>where we're going to rely on the Kubernetes

00:04:14.520 --> 00:04:16.440
<v Speaker 0>service discovery configuration.

00:04:17.079 --> 00:04:19.079
<v Speaker 0>And here, I'm asking it to find all

00:04:19.079 --> 00:04:19.639
<v Speaker 0>pods.

00:04:20.965 --> 00:04:23.925
<v Speaker 0>Next, we can define the relabel config.

00:04:23.925 --> 00:04:25.605
<v Speaker 0>This will allow us to keep or drop

00:04:25.605 --> 00:04:29.045
<v Speaker 0>different targets based on attributes within the target

00:04:29.045 --> 00:04:29.845
<v Speaker 0>itself,

00:04:30.245 --> 00:04:31.125
<v Speaker 0>the pod.

00:04:31.685 --> 00:04:34.245
<v Speaker 0>So here, we can see that we only

00:04:34.245 --> 00:04:35.525
<v Speaker 0>want to keep

00:04:36.300 --> 00:04:40.060
<v Speaker 0>discovered pods as a target if it has

00:04:40.060 --> 00:04:41.259
<v Speaker 0>a Parca.

00:04:41.259 --> 00:04:44.220
<v Speaker 0>Dev slash profile annotation.

00:04:45.020 --> 00:04:46.460
<v Speaker 0>You can see here we're asking for the

00:04:46.460 --> 00:04:49.740
<v Speaker 0>Kubernetes metadata on the pod and annotations.

00:04:50.735 --> 00:04:53.055
<v Speaker 0>This name here is just a

00:04:53.215 --> 00:04:56.574
<v Speaker 0>simplified version of parka dot dev slash profile

00:04:56.574 --> 00:04:59.775
<v Speaker 0>where dots and slashes are replaced with underscores.

00:05:00.974 --> 00:05:02.335
<v Speaker 0>And we're just going to say

00:05:02.735 --> 00:05:03.055
<v Speaker 0>keep.

00:05:05.550 --> 00:05:07.950
<v Speaker 0>Now we also need to handle where the

00:05:07.950 --> 00:05:10.270
<v Speaker 0>p professor information is available on different paths

00:05:10.270 --> 00:05:11.790
<v Speaker 0>and on different ports.

00:05:12.750 --> 00:05:14.350
<v Speaker 0>So here, we can say that we expect

00:05:14.350 --> 00:05:17.310
<v Speaker 0>an annotation of parca dot dev slash path.

00:05:17.895 --> 00:05:18.775
<v Speaker 0>This

00:05:18.775 --> 00:05:20.535
<v Speaker 0>will be our metrics path.

00:05:21.095 --> 00:05:23.335
<v Speaker 0>Likewise, we can see the Parca dot dev

00:05:23.335 --> 00:05:24.455
<v Speaker 0>slash port,

00:05:24.775 --> 00:05:26.055
<v Speaker 0>and we can actually

00:05:26.294 --> 00:05:28.215
<v Speaker 0>construct or compose

00:05:28.935 --> 00:05:31.575
<v Speaker 0>the address from all previous information.

00:05:33.449 --> 00:05:34.570
<v Speaker 0>And that's it.

00:05:35.449 --> 00:05:36.330
<v Speaker 0>However,

00:05:36.490 --> 00:05:38.490
<v Speaker 0>we said something a few moments ago that's

00:05:38.490 --> 00:05:39.610
<v Speaker 0>worth good over again.

00:05:40.490 --> 00:05:42.970
<v Speaker 0>The Kubernetes service discovery config

00:05:43.130 --> 00:05:45.530
<v Speaker 0>will currently try to find all pods.

00:05:46.384 --> 00:05:49.345
<v Speaker 0>The all pods is subjective and that do

00:05:49.345 --> 00:05:51.425
<v Speaker 0>you want to bind it to a namespace

00:05:51.425 --> 00:05:53.185
<v Speaker 0>or be cluster wide.

00:05:53.745 --> 00:05:54.625
<v Speaker 0>Regardless,

00:05:54.625 --> 00:05:55.985
<v Speaker 0>Parca needs

00:05:56.625 --> 00:05:57.825
<v Speaker 0>some permissions

00:05:57.985 --> 00:05:59.505
<v Speaker 0>in order to be able to do so.

00:06:01.080 --> 00:06:03.720
<v Speaker 0>As such, I've chosen to define a cluster

00:06:03.720 --> 00:06:04.520
<v Speaker 0>role,

00:06:04.600 --> 00:06:06.919
<v Speaker 0>which gives it the ability to watch, list,

00:06:06.919 --> 00:06:08.360
<v Speaker 0>and get all pods

00:06:08.760 --> 00:06:10.199
<v Speaker 0>across the entire cluster.

00:06:13.255 --> 00:06:15.815
<v Speaker 0>This is not a video on Kubernetes RBAG.

00:06:15.815 --> 00:06:17.735
<v Speaker 0>So if you want to do this differently,

00:06:18.055 --> 00:06:19.015
<v Speaker 0>feel free.

00:06:19.255 --> 00:06:21.575
<v Speaker 0>I'm just keeping things simple and easy for

00:06:21.575 --> 00:06:22.775
<v Speaker 0>today's demonstration.

00:06:24.135 --> 00:06:26.295
<v Speaker 0>Once we have the cluster role, we must

00:06:26.295 --> 00:06:28.920
<v Speaker 0>bind it to the Parca servers account inside

00:06:28.920 --> 00:06:30.840
<v Speaker 0>of the Parca namespace.

00:06:32.360 --> 00:06:33.080
<v Speaker 0>Simple.

00:06:34.520 --> 00:06:36.440
<v Speaker 0>So we can come back to the command

00:06:36.440 --> 00:06:37.160
<v Speaker 0>line

00:06:37.480 --> 00:06:39.720
<v Speaker 0>where we can run goof control and play

00:06:40.440 --> 00:06:43.725
<v Speaker 0>to update the contact map and to apply

00:06:43.725 --> 00:06:47.085
<v Speaker 0>the cluster role and cluster role binding.

00:06:50.365 --> 00:06:52.285
<v Speaker 0>Now if we can come back to Parca

00:06:52.285 --> 00:06:53.085
<v Speaker 0>server,

00:06:53.165 --> 00:06:55.485
<v Speaker 0>wherever we have refresh, we should see the

00:06:55.485 --> 00:06:57.725
<v Speaker 0>new job for our script configuration.

00:06:59.500 --> 00:07:00.300
<v Speaker 0>Like so.

00:07:01.419 --> 00:07:04.540
<v Speaker 0>Okay. So we've refreshed and nothing has happened.

00:07:04.540 --> 00:07:06.860
<v Speaker 0>But of course, that's because we need to

00:07:06.860 --> 00:07:08.380
<v Speaker 0>do one more thing.

00:07:08.620 --> 00:07:10.940
<v Speaker 0>That is we need to add our annotations

00:07:10.940 --> 00:07:13.100
<v Speaker 0>to the influx DB workload.

00:07:14.115 --> 00:07:16.115
<v Speaker 0>So let's jump back over to our terminal

00:07:16.514 --> 00:07:18.754
<v Speaker 0>where we can go to control edit

00:07:18.754 --> 00:07:21.955
<v Speaker 0>stateful set influx DB two.

00:07:23.235 --> 00:07:26.514
<v Speaker 0>We can jump down to the template

00:07:26.990 --> 00:07:28.510
<v Speaker 0>for all the pods

00:07:28.830 --> 00:07:31.550
<v Speaker 0>where we can add our annotations.

00:07:36.350 --> 00:07:38.430
<v Speaker 0>You can say parka.dev

00:07:38.430 --> 00:07:39.870
<v Speaker 0>slash profile.

00:07:40.430 --> 00:07:41.870
<v Speaker 0>We can just set that to true.

00:07:43.205 --> 00:07:45.605
<v Speaker 0>We also need to set our parka.dev

00:07:45.605 --> 00:07:48.565
<v Speaker 0>slash path to be our path to the

00:07:48.565 --> 00:07:49.845
<v Speaker 0>p professor endpoint

00:07:50.085 --> 00:07:53.045
<v Speaker 0>on Parca.

00:07:53.045 --> 00:07:54.485
<v Speaker 0>Dev port

00:07:54.725 --> 00:07:56.165
<v Speaker 0>to eight zero eight six.

00:07:57.510 --> 00:07:59.030
<v Speaker 0>Now on InfluxDB,

00:07:59.030 --> 00:08:01.670
<v Speaker 0>the p professor endpoint is available at debug

00:08:02.070 --> 00:08:02.950
<v Speaker 0>p professor.

00:08:03.830 --> 00:08:04.390
<v Speaker 0>So

00:08:05.590 --> 00:08:07.030
<v Speaker 0>now we can hit save

00:08:07.910 --> 00:08:09.350
<v Speaker 0>and our Parker server

00:08:10.085 --> 00:08:12.245
<v Speaker 0>will reach out to the k the Kubernetes

00:08:12.245 --> 00:08:13.525
<v Speaker 0>API server,

00:08:13.525 --> 00:08:16.645
<v Speaker 0>get information on the pods, find our annotations

00:08:16.645 --> 00:08:17.845
<v Speaker 0>and update

00:08:19.125 --> 00:08:20.965
<v Speaker 0>our target list.

00:08:22.725 --> 00:08:23.925
<v Speaker 0>So let's hit refresh.

00:08:26.280 --> 00:08:27.400
<v Speaker 0>And there we go.

00:08:27.960 --> 00:08:29.960
<v Speaker 0>We can now see the pod IP for

00:08:29.960 --> 00:08:32.840
<v Speaker 0>our influx DB pod. Debug p professor based

00:08:32.840 --> 00:08:34.679
<v Speaker 0>path and it is now detected

00:08:34.840 --> 00:08:37.960
<v Speaker 0>allocations, block, go routines, mutex,

00:08:37.960 --> 00:08:38.840
<v Speaker 0>and point.

00:08:39.240 --> 00:08:40.440
<v Speaker 0>These are now

00:08:40.865 --> 00:08:41.584
<v Speaker 0>good

00:08:41.745 --> 00:08:44.545
<v Speaker 0>or they all will be good in time.

00:08:45.665 --> 00:08:47.425
<v Speaker 0>This now means we can head over to

00:08:47.425 --> 00:08:48.305
<v Speaker 0>profiles

00:08:48.384 --> 00:08:50.545
<v Speaker 0>where we have all the profiles being script.

00:08:54.250 --> 00:08:57.050
<v Speaker 0>So let's just do go routines being created.

00:08:58.490 --> 00:09:00.490
<v Speaker 0>Filter on our job, which is just gonna

00:09:00.490 --> 00:09:02.010
<v Speaker 0>be p professor endpoints.

00:09:03.450 --> 00:09:04.330
<v Speaker 0>Let go.

00:09:04.970 --> 00:09:07.450
<v Speaker 0>Now we can see our new profile and

00:09:07.450 --> 00:09:10.935
<v Speaker 0>information being collected from the influx d endpoint

00:09:11.015 --> 00:09:12.455
<v Speaker 0>using annotations

00:09:12.455 --> 00:09:13.735
<v Speaker 0>on the workload

00:09:13.815 --> 00:09:17.335
<v Speaker 0>with dynamic scrape config using the Kubernetes service

00:09:17.335 --> 00:09:18.775
<v Speaker 0>discovery config.

00:09:19.415 --> 00:09:19.895
<v Speaker 0>Awesome.

00:09:21.830 --> 00:09:25.590
<v Speaker 0>Okay. So the takeaway here is, first, if

00:09:25.590 --> 00:09:27.510
<v Speaker 0>you can use the Parca agent and you

00:09:27.510 --> 00:09:30.150
<v Speaker 0>get everything you need, just use the Parca

00:09:30.150 --> 00:09:30.950
<v Speaker 0>agent.

00:09:31.270 --> 00:09:31.990
<v Speaker 0>However,

00:09:32.230 --> 00:09:33.990
<v Speaker 0>if you have Google applications,

00:09:33.990 --> 00:09:36.935
<v Speaker 0>Node. Js applications, other environments where you need

00:09:36.935 --> 00:09:39.575
<v Speaker 0>to rely or want to consume more information

00:09:39.575 --> 00:09:42.055
<v Speaker 0>using language specific integrations,

00:09:42.375 --> 00:09:44.295
<v Speaker 0>they're very easy to configure.

00:09:44.775 --> 00:09:47.095
<v Speaker 0>Within a Kubernetes environment, you just need to

00:09:47.095 --> 00:09:48.455
<v Speaker 0>give your Parca server

00:09:48.680 --> 00:09:51.959
<v Speaker 0>the right access to query nodes, services, endpoints,

00:09:51.959 --> 00:09:55.560
<v Speaker 0>or pods depending on your Prometheus scrape configuration.

00:09:56.360 --> 00:09:58.360
<v Speaker 0>From there, you can configure your workloads with

00:09:58.360 --> 00:09:59.880
<v Speaker 0>the appropriate annotations,

00:09:59.959 --> 00:10:01.800
<v Speaker 0>and the job is done.

00:10:02.360 --> 00:10:03.160
<v Speaker 0>So go forth.

00:10:03.803 --> 00:10:06.923
<v Speaker 0>Profile everything under Kubernetes with Parca.

00:10:07.403 --> 00:10:08.283
<v Speaker 0>Go have some fun.
